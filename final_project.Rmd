---
title: "Final Project"
author: "Elena Novikova"
date: "5/04/2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
```



```{r}

library(tidyverse)
library(lubridate)
library(magrittr)
library(readxl)
library(dplyr)
library(stringr)
library(openxlsx)
library(knitr)
library(rvest)
library(choroplethr)
library(choroplethrMaps)

```

&nbsp;
&nbsp;
&nbsp;
&nbsp;

```{r Web scraping from data.gov}

CHSIdescrip <- "https://catalog.data.gov/dataset/community-health-status-indicators-chsi-to-combat-obesity-heart-disease-and-cancer" %>%
  read_html() %>% html_nodes(".module-content") %>%
  html_text()
CHSIdescrip <- tibble(text = CHSIdescrip)
CHSIdescrip <- CHSIdescrip[[1,1]]
#strwrap(CHSIdescrip, width = 80)


CHSIheader <- str_extract(CHSIdescrip, "[^\n \t].*")
CHSIdate <- str_extract(CHSIdescrip, "M.*")
CHSItext <- str_extract(CHSIdescrip, "\n +C.*") 
CHSItext <- str_remove_all(CHSItext, "\n  +")
CHSItable <- tibble(x = c(CHSIheader, CHSIdate, CHSItext))
kable(CHSItable, caption = "CHSItable")
```

&nbsp;
&nbsp;
&nbsp;
&nbsp;

The file called DATAELEMENTDESCRIPTION.csv contains column names and column descriptions for each file from the source. I will import it and turn into a dataframe with values in the first column corresponding to file names, and second column containing dataframes with column descriptions for each file:

&nbsp;
&nbsp;
&nbsp;
&nbsp;

```{r working with DATAELEMENTDESCRIPTION file}

DATAELEMENTDESCRIPTION <- read.csv("DATAELEMENTDESCRIPTION.csv")


DATAELEMENTDESCRIPTION <- DATAELEMENTDESCRIPTION %>% 
  group_by(PAGE_NAME) %>% 
  nest()
glimpse(DATAELEMENTDESCRIPTION)

DATAELEMENTDESCRIPTION

```





&nbsp;
&nbsp;
&nbsp;
&nbsp;

```{r Peer counties decription}
county_fips_descrip <- read_excel("CHSIpeers.xlsx", sheet = 1)
county_fips_descrip <- county_fips_descrip[[2,1]]
kable(county_fips_descrip, caption = "Peer Counties")

```

&nbsp;
&nbsp;
&nbsp;
&nbsp;

```{r Importing Peer counties table}
county_fips <- read_excel("CHSIpeers.xlsx", sheet = 2)
#Renaming columns to remove blank spaces:
county_fips <- county_fips %>% 
  transmute(FIPS = `County FIPS code`, County_Name_State = `County Name, State`, PeerCountyGroup = `Peer County Group`)


```

&nbsp;
&nbsp;
&nbsp;
&nbsp;

Output files County_FIPS.xlsx and County_FIPS.csv are generated.

&nbsp;
&nbsp;
&nbsp;
&nbsp;




```{r Scraping names of counties and states}
county_fips <- county_fips %>% 
  mutate(County = str_extract(County_Name_State, ".*(?=,)"),
          State = str_extract(County_Name_State, "(?<=, ).*")) %>% 
  select(-County_Name_State)

write_excel_csv(county_fips, "County_FIPS.csv")
write.xlsx(county_fips, "County_FIPS.xlsx")

```

&nbsp;
&nbsp;
&nbsp;
&nbsp;

I am a resident of Passaic county, NJ. Let's find what Strata my county belongs to, find Peer counties in this Strata, and count how many Peer counties are there:

```{r Passaic county Strata number, list of counties}
Passaic <- filter(county_fips,County == "Passaic County")
Passaic <- as.character(Passaic$PeerCountyGroup)
PassaicStrata = str_c("Passaic county, NJ belongs to strata ", Passaic)
print(PassaicStrata)

PassaicStrata <- county_fips %>% filter(PeerCountyGroup == Passaic)
tc <- PassaicStrata %>% summarise(count = n())
tc <- as.character(tc$count[[1]])

Mystrata_table_title = str_c("Peer counties in Strata ", Passaic, ", a total of ", tc, " counties")

kable(PassaicStrata, caption = Mystrata_table_title)

```



```{r Poverty levels by strata}
demographics <- read.csv("DEMOGRAPHICS.csv")


PovertyByStrata <- demographics %>% 
  group_by(Strata_ID_Number) %>%
  filter(Poverty > 0) %>% 
  summarise(Poverty = mean(Poverty))

PovertyByStrata <- PovertyByStrata %>%
  arrange(Poverty) %>% 
  mutate(rank = row_number())

StrataCount <- summarise(PovertyByStrata, count = n())
StrataCount <- StrataCount[[1]]

```


```{r My strata ranking by Poverty level}

Strata9 <- PovertyByStrata %>% filter(Strata_ID_Number == Passaic)

Strata9ranking <- Strata9$rank[[1]]


print(str_c("Passaic county, NJ belongs to Strata ", Passaic, " that ranks ", Strata9ranking, "th lowest in Poverty level "))
print(str_c("amongst the total of ", StrataCount, " Stratas in the US."))
```


```{r Bar plot of stratas by Poverty level}

ggplot(data = PovertyByStrata, aes(Strata_ID_Number, Poverty)) +
  geom_bar(stat = "identity") +
  geom_bar(data = Strata9, aes(Strata_ID_Number, Poverty, fill = Strata_ID_Number), stat = "identity", show.legend = FALSE)+ 
  ggtitle("County data per strata, individuals living below poverty level, %") +
  xlab("Strata ID") + ylab("Poverty, %")

```




```{r Sorting out lowest income strata}
PovertyStrataMax <- PovertyByStrata %>% arrange(desc(Poverty)) %>% head(1)
psmax <- PovertyStrataMax[[1]]

PovertyMax_list <- demographics %>% 
  filter(Strata_ID_Number == psmax) %>% 
  select(CHSI_County_Name, CHSI_State_Name, Poverty) %>% 
  arrange(desc(Poverty))

psmax <- str_c("A strata with the highest % of population living below poverty line is ", psmax)
kable(head(PovertyMax_list), caption = psmax)

```




```{r}
PovertyStrataMin <- PovertyByStrata %>% arrange(Poverty) %>% head(1)
psmin <- PovertyStrataMin[[1]]
  
PovertyMin_list <- demographics %>% 
  filter(Strata_ID_Number == psmin) %>% 
  select(CHSI_County_Name, CHSI_State_Name, Poverty) %>% 
  arrange(Poverty)
kable(head(PovertyMin_list), caption = str_c("A strata with the lowest % of population living below poverty line is ", psmin))

```



```{r Extracting population density from demographics}
# Extracting columns for Population_Density.
# Negative values in Population_Density column stand for "no data available", these lines need to be removed
Pop_dens <- demographics %>% select(State_FIPS_Code, County_FIPS_Code, CHSI_County_Name, CHSI_State_Name, Strata_ID_Number, Population_Density) %>% 
  filter(Population_Density >= 0)
kable(head(select(Pop_dens, CHSI_County_Name, CHSI_State_Name, Population_Density)), caption = "County data, population density (people per square mile)")
```

```{r Top 10 counties with highest population density}

Top10Pop_dens <- Pop_dens %>% arrange(desc(Population_Density)) %>% head(10)

kable(select(Top10Pop_dens, CHSI_County_Name, CHSI_State_Name, Population_Density), caption = "Top 10 counties with highest population density in the US")

```


Four of the boroughs of New York City are leading the list leaving other counties far behind. No wonder they have the most of COVID-19 cases.





```{r average life expectancy from SummaryMeasuresOfHealth table}
SummaryMeasuresOfHealth <- read.csv("SUMMARYMEASURESOFHEALTH.csv")
# Extracting columns for average life expectancy (ALE).
# Negative values in ALE column stand for "no data available", these lines need to be removed
ALEdf <- SummaryMeasuresOfHealth %>% 
  select(State_FIPS_Code, County_FIPS_Code, CHSI_County_Name, CHSI_State_Name, Strata_ID_Number, ALE) %>% 
  filter(ALE > 0)
kable(head(select(ALEdf, CHSI_County_Name, CHSI_State_Name, ALE)), caption = "County data, average life expectancy")

```
&nbsp;
&nbsp;
&nbsp;
&nbsp;

&nbsp;
&nbsp;
&nbsp;
&nbsp;

Let's left join the Population density and the Life Expectancy data frames:

```{r join Pop_dens and ALEdf tables}

Pop_dens_ALEdf <- drop_na(left_join(Pop_dens, ALEdf))

kable(head(select(Pop_dens_ALEdf, CHSI_County_Name, CHSI_State_Name, Population_Density, ALE)), caption = "Population Density and Average Life Expectancy by county")

```
&nbsp;
&nbsp;
&nbsp;
&nbsp;

&nbsp;
&nbsp;
&nbsp;
&nbsp;


Let's build a Linear Model of ALE ~ Population_Density: 


```{r Linear Model ALE and Population_Density }
ALElm <- lm(ALE ~ Population_Density, data=Pop_dens_ALEdf)
Pop_dens_ALEdf$fit <- ALElm[["fitted.values"]]


```

```{r Plotting LM ALE and Pop dens}

Pop_dens_ALEdf %>% 
  ggplot(aes(Population_Density, fit)) + geom_line(colour = 'red') + 
  ggtitle("Linear Model of ALE ~ Population_Density") +
  geom_point(aes(Population_Density, ALE)) +
  ylab("Average Life Expectancy") +
  xlab("Population Density (people per sq mi)")


```



&nbsp;
&nbsp;
&nbsp;
&nbsp;
```{r LM ALE and Poverty}
Poverty_lvl <- demographics %>% 
  select(State_FIPS_Code, County_FIPS_Code, CHSI_County_Name, CHSI_State_Name, Strata_ID_Number, Poverty) %>% 
  filter(Poverty > 0)

ALE_Poverty_lvl <- drop_na(left_join(ALEdf, Poverty_lvl))

PovertyLM <- lm(ALE ~ Poverty, data=ALE_Poverty_lvl)

ALE_Poverty_lvl$fit <- PovertyLM[["fitted.values"]]

summary(ALE_Poverty_lvl)

```


&nbsp;
&nbsp;
&nbsp;
&nbsp;
```{r Plotting LM ALE and Poverty}
ALE_Poverty_lvl %>% 
  ggplot(aes(Poverty, fit)) + geom_line(colour = 'red') + 
  ggtitle("Linear Model of ALE ~ Poverty") +
  geom_point(aes(Poverty, ALE)) +
  ylab("Average Life Expectancy") +
  xlab("Individuals Living Below Poverty line, %")
```





&nbsp;
&nbsp;
&nbsp;
&nbsp;
```{r average life expectancy by county US map}
ALEdf1 <- ALEdf

ALEdf1$State_FIPS_Code <- as.character(ALEdf1$State_FIPS_Code)

ALEdf1$County_FIPS_Code <- as.character(ALEdf1$County_FIPS_Code)

ALEdf1$County_FIPS_Code <- if_else(str_length(ALEdf1$County_FIPS_Code) == 1, str_c("00", ALEdf1$County_FIPS_Code), ALEdf1$County_FIPS_Code)

ALEdf1$County_FIPS_Code <- if_else(str_length(ALEdf1$County_FIPS_Code) == 2, str_c("0", ALEdf1$County_FIPS_Code), ALEdf1$County_FIPS_Code)

ALEdf1$FIPS <- as.numeric(str_c(ALEdf1$State_FIPS_Code, ALEdf1$County_FIPS_Code))

ALEdf1 <- ALEdf1 %>% select(FIPS, CHSI_County_Name, CHSI_State_Name, ALE)

kable(head(ALEdf1), caption = "FIPS codes added to the Average Life Expectancy by county dataframe")

ALEdfPlot <- ALEdf1 %>% rename(value = ALE, region = FIPS)
county_choropleth(ALEdfPlot, title = "Average Life Expectancy by county",legend = "Age", num_colors = 9)


```

```{r average life expectancy in NJ and NY}
county_choropleth(ALEdfPlot, title = "New Jersey and New York, Average Life Expectancy by county",legend = "Age", state_zoom = c("new jersey", "new york"), num_colors = 9)
NJ_ALE <- county_choropleth(ALEdfPlot, title = "NJ Average Life Expectancy",legend = "Age", state_zoom = "new jersey", num_colors = 9)
```


```{r exporting average life expectancy with FIPS codes in excel}
write.xlsx(ALEdf1, "ALE_with_FIPS.xlsx")
```

&nbsp;
&nbsp;
&nbsp;
&nbsp;

An excel file of average life expectancy with FIPS codes named ALE_with_FIPS.xlsx is created.




```{r New Jersey Rankings Data}

NJ2010 <- read_excel("2010 County Health Ranking New Jersey Data - v2.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2010" = `Adult obesity`)
NJ2010$"2010" <- as.double(NJ2010$"2010")

NJ2011 <- read_excel("2011 County Health Ranking New Jersey Data - v4.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2011" = `Adult obesity`)
NJ2011$"2011" <- as.double(NJ2011$"2011")

NJ2012 <- read_excel("2012 County Health Ranking New Jersey Data - v4.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2012" = `Adult obesity`)
NJ2012$"2012" <- as.double(NJ2012$"2012")

NJ2013 <- read_excel("2013 County Health Ranking New Jersey Data - v1_0.xls", sheet = 5) %>% 
  select(FIPS = `*Data for measures with an asterisk should not be compared with prior years due to changes in definition.`, County = `...3`, "2013" = `Adult obesity`)
NJ2013$"2013" <- as.double(NJ2013$"2013")

NJ2014 <- read_excel("2014 County Health Rankings New Jersey Data - v6.xls", sheet = 4) %>% 
  select(FIPS = `*Data for measures with an asterisk should not be compared with prior years due to changes in definition.`, County = `...3`, "2014" = `Adult obesity`)
NJ2014$"2014" <- as.double(NJ2014$"2014")

NJ2015 <- read_excel("2015 County Health Rankings New Jersey Data - v3.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2015" = `Adult obesity`)
NJ2015$"2015" <- as.double(NJ2015$"2015")

NJ2016 <- read_excel("2016 County Health Rankings New Jersey Data - v3.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2016" = `Adult obesity`)
NJ2016$"2016" <- as.double(NJ2016$"2016")

NJ2017 <- read_excel("2017 County Health Rankings New Jersey Data - v2.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2017" = `Adult obesity`)
NJ2017$"2017" <- as.double(NJ2017$"2017")

NJ2018 <- read_excel("2018 County Health Rankings New Jersey Data - v3.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2018" = `Adult obesity`)
NJ2018$"2018" <- as.double(NJ2018$"2018")

NJ2019 <- read_excel("2019 County Health Rankings New Jersey Data - v1_0.xls", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2019" = `Adult obesity`)
NJ2019$"2019" <- as.double(NJ2019$"2019")

NJ2020 <- read_excel("2020 County Health Rankings New Jersey Data - v1_0.xlsx", sheet = 4) %>% 
  select(FIPS = `...1`, County = `...3`, "2020" = `Adult obesity`)
NJ2020$"2020" <- as.double(NJ2020$"2020")

NJobesity <- left_join(NJ2010, NJ2011)
NJobesity <- left_join(NJobesity, NJ2012)
NJobesity <- left_join(NJobesity, NJ2013)
NJobesity <- left_join(NJobesity, NJ2014)
NJobesity <- left_join(NJobesity, NJ2015)
NJobesity <- left_join(NJobesity, NJ2016)
NJobesity <- left_join(NJobesity, NJ2017)
NJobesity <- left_join(NJobesity, NJ2018)
NJobesity <- left_join(NJobesity, NJ2019)
NJobesity <- drop_na(left_join(NJobesity, NJ2020))

kable(NJobesity, caption = "New Jersey Adult Obesity levels, %")

NJ2020 <- NJ2020 %>% rename(value = "2020", region = FIPS) %>% drop_na()
NJ2020$region <- as.numeric(NJ2020$region)

NJobesity_plot <- county_choropleth(NJ2020, title = "NJ Obesity levels, %", state_zoom = "new jersey", num_colors = 9)

library(gridExtra)
grid.arrange(NJ_ALE, NJobesity_plot, ncol=2)

#gather()

```


```{r}

```



&nbsp;
&nbsp;
&nbsp;
&nbsp;

Bibliography:

1. The County Health Rankings & Roadmaps program. (August 30, 2017). Peer Counties Tool.

Retrieved 30 April 2020, from https://www.countyhealthrankings.org/resources/peer-counties-tool

2. The County Health Rankings & Roadmaps program. (2020). New Jersey Rankings Data.

Retrieved 30 April 2020, from https://www.countyhealthrankings.org/app/new-jersey/2020/downloads

3. U.S. Governmentâ€™s open data. (February 26, 2020). Community Health Status Indicators (CHSI) to Combat Obesity, Heart Disease and Cancer.

Retrieved 30 April 2020, from https://catalog.data.gov/dataset/community-health-status-indicators-chsi-to-combat-obesity-heart-disease-and-cancer
